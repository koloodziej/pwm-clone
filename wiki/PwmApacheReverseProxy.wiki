#summary Pwm behind an Apache reverse proxy

= Introduction =

There are a couple of good reasons to place Pwm behind a reverse proxy:

  * Blocking certains pwm functions for good (e.g. /admin, /config)
  * Masking pwm server's real DNS name, e.g. to avoid having to buy a separate SSL certificate for it

These instructions are for Apache 2.2 running on Debian Lenny, with Pwm rev 160 running on Debian Squeeze and Tomcat 6.

= Configuring Pwm server =

On Pwm side most configuration is related to security. You have three options:

  * Let Apache contact pwm using insecure HTTP protocol (e.g. port 8080 or 8180). This setup will become slightly more secure if firewall (or Tomcat) is used to block access from IPs other than that of Apache.
  * Allow Tomcat/Pwm access only using HTTPS. This will require additional configuration at the Apache end. This can be made more secure by limiting access to the webserver's IP.
  * Secure Apache < - > Tomcat/pwm connection using VPN such as [http://openvpn.net OpenVPN]. Block all other access to Pwm.

In pwm configuration make sure to turn _enableSessionVerification_ to _false_, or reverse proxying will not work properly.

= Configuring the webserver =

Adding reverse proxy support to Apache is relatively easy. Go to _/etc/apache2/sites-available_ and place something like this to the appropriate section:

{{{
        # Reverse proxying setup for other webservers running on localhost
        # or on remote servers. Configuration details available here:
        #
        # http://httpd.apache.org/docs/2.2/mod/mod_proxy.html

        # Reverse proxies don't need to allow proxy requests
        ProxyRequests Off

        # Proxy access control - not very important in reverse proxies
        # as the target servers have been predefined by the sysadmin
        <Proxy *>
                Order deny,allow
                Allow from all
        </Proxy>

        # No need to proxy SSL-enabled servers (yet)
        #SSLProxyEngine On

        # This is required to connect to SSL-enabled servers not running
        # on port 443
        #AllowCONNECT 8443

        # Block access to administrative functions, see
        #
        # http://httpd.apache.org/docs/2.2/mod/mod_proxy.html#proxypass
        ProxyPass /pwm/admin !
        ProxyPass /pwm/config !

        # Map local server URL to a remote server URL. We're using HTTP through
        # secure VPN connection.
        ProxyPass /pwm http://<pwm-server-ip>:8080/pwm

        # This rewrites HTTP headers etc. so that proxied server's
        # responses point the client back to this server, not the
        # proxied server
        ProxyPassReverse /pwm http://<pwm-server-ip>:8080/pwm
}}}

Note that using any other path than /pwm will not work, at least out of the box. For example, submitting the CAPTCHA for will fail with _"Form submitted with incorrect pwmFormID value"_ error.